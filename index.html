<!DOCTYPE html>
<html lang="en" class="scroll-smooth h-full">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ChatGPT Advanced Client</title>
  <meta name="description" content="An advanced, single-file, privacy-first client for OpenAI models.">
  <link rel="manifest" href="data:application/manifest+json,{"name":"ChatGPT Advanced","short_name":"Chat","start_url":".","display":"standalone","background_color":"#111827","theme_color":"#2563eb","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50,9A41,41,0,0,0,9,50a41,41,0,0,0,41,41,40.7,40.7,0,0,0,29.12-12.07l-10-10A25.82,25.82,0,0,1,50,75.82,25.82,25.82,0,1,1,75.82,50H63.18a13.18,13.18,0,1,0-13.18,13.18V50A13.18,13.18,0,1,0,50,36.82,13.18,13.18,0,0,0,36.82,50H50A25.82,25.82,0,0,1,50,9Z' fill='%232563eb'/%3E%3C/svg%3E","sizes":"192x192","type":"image/svg+xml"}]}">

  <!-- Content-Security-Policy -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://*.tailwindcss.com https://*.jsdelivr.net https://api.openai.com;
                 img-src 'self' data: blob:;
                 style-src 'self' 'unsafe-inline' https://*.tailwindcss.com;
                 script-src 'self' 'unsafe-inline' https://*.tailwindcss.com https://*.jsdelivr.net blob:;
                 worker-src 'self' blob:;">

  <!-- Libs: Tailwind, marked, DOMPurify, tiktoken -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
  <script type="module">
    import * as tiktoken from "https://cdn.jsdelivr.net/npm/@dqbd/tiktoken@1.0.14/lite/init";
    window.tiktoken = tiktoken;
  </script>

  <style>
    .sidebar { transform: translateX(-100%); transition: transform .3s ease; }
    .sidebar.open { transform: translateX(0); }
    textarea { overflow-y: auto; resize: none; }
    .modal-bg { background: rgba(0,0,0,.6); }
    .focus-trap:focus-visible { outline: 2px solid #2563eb; outline-offset: 2px; }
    .msg-actions button { cursor: pointer; opacity: .5; transition: opacity .2s; }
    .msg-actions button:hover { opacity: 1; }
    .prose table { width: 100%; }
    .prose th { background-color: #f3f4f6; }
    .dark .prose th { background-color: #374151; }
    .prose th, .prose td { border: 1px solid #d1d5db; padding: 0.5rem; }
    .dark .prose th, .dark .prose td { border-color: #4b5563; }
  </style>
</head>
<body class="flex flex-col h-full bg-white dark:bg-gray-900 text-gray-800 dark:text-white overflow-x-hidden">

<!-- ───────────────── Header ───────────────── -->
<nav class="fixed inset-x-0 top-0 flex items-center gap-2 px-2 sm:px-4 py-2 bg-blue-600 dark:bg-gray-800 text-white z-20">
  <button id="menuBtn" aria-expanded="false" class="p-1 focus-trap"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button>
  <button id="modelBtn" aria-haspopup="dialog" class="flex items-center px-2 py-1 bg-white text-gray-800 dark:bg-gray-700 rounded focus-trap"><span id="currentModel" class="truncate max-w-[6rem] sm:max-w-[8rem]">gpt-4o</span><svg class="h-4 w-4 ml-1" fill="currentColor" viewBox="0 0 20 20"><path d="M5.23 7.21a.75.75 0 011.06.02L10 11.087l3.71-3.856a.75.75 0 011.08 1.04l-4.25 4.414a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z"/></svg></button>
  <span id="liveCost" class="text-xs opacity-80">…</span>
  <span class="flex-1"></span>
  <button id="newChatBtnHeader" class="p-2 bg-white text-gray-800 dark:bg-gray-700 rounded-full focus-trap"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></button>
  <button id="settingsOpener" class="p-2 bg-white text-gray-800 dark:bg-gray-700 rounded-full focus-trap"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
</nav>

<!-- ───────────────── Sidebar ───────────────── -->
<aside id="sidebar" class="sidebar fixed top-0 left-0 h-full w-full sm:w-72 bg-white dark:bg-gray-800 shadow-lg p-4 pt-20 z-10 overflow-y-auto">
  <button id="closeSidebar" class="absolute top-4 right-4 text-gray-700 dark:text-white focus-trap">✖</button>
  <details open>
    <summary class="font-medium cursor-pointer">Chats</summary>
    <div class="mt-2 space-y-2">
      <ul id="threadList" class="space-y-1"></ul>
    </div>
  </details>
</aside>

<!-- ───────────────── Chat Area ───────────────── -->
<main class="flex-1 flex flex-col pt-16 pb-20">
  <section id="chat" role="log" class="flex-1 overflow-y-auto p-2 sm:p-4 space-y-4"></section>
</main>

<!-- ───────────────── Input Bar ───────────────── -->
<div class="fixed bottom-0 inset-x-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-2 sm:p-4">
  <div class="flex gap-2 items-end max-w-4xl mx-auto">
    <button id="attachBtn" class="p-2.5 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 focus-trap hidden" title="Attach Image (Vision)"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg></button>
    <textarea id="userInput" rows="1" placeholder="Type a message…" class="flex-1 border rounded-lg px-3 py-2.5 dark:bg-gray-700 dark:border-gray-600 focus-trap"></textarea>
    <button id="sendBtn" class="bg-blue-600 text-white px-4 py-2.5 rounded-lg flex items-center focus-trap" disabled><svg id="sendIcon" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><svg id="spinner" class="h-5 w-5 animate-spin hidden" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V8z"/></svg></button>
  </div>
</div>

<!-- ───────────────── Modals ───────────────── -->
<div id="modelModal" class="modal-bg fixed inset-0 hidden items-center justify-center z-30" role="dialog"><div class="bg-white dark:bg-gray-800 rounded-lg w-11/12 max-w-sm p-4 relative shadow-lg max-h-[80vh] overflow-y-auto"><button id="closeModelModal" class="absolute top-3 right-3 text-gray-500 focus-trap">✖</button><h2 class="text-lg font-semibold text-center mb-3">Switch model</h2><div id="modelList" class="space-y-2"></div></div></div>
<div id="settingsModal" class="modal-bg fixed inset-0 hidden items-center justify-center z-40" role="dialog"><div class="bg-white dark:bg-gray-800 rounded-lg w-11/12 max-w-2xl p-4 sm:p-6 relative shadow-lg max-h-[90vh] overflow-y-auto"><button id="closeSettingsModal" class="absolute top-3 right-3 text-gray-500 focus-trap">✖</button><h2 class="text-2xl font-semibold mb-4">Settings</h2><div class="space-y-6" id="settingsContent"></div></div></div>

<input type="file" id="attachFileInput" class="hidden" accept="image/*">

<!-- ───────────────── Templates ───────────────── -->
<template id="settings-template">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- General Settings -->
    <div class="space-y-4">
      <h3 class="text-lg font-medium border-b pb-2">General</h3>
      <div><label for="apiKeyInput">API Key</label><div id="apiKeyContainer" class="relative"><input id="apiKeyInput" type="password" placeholder="sk-..." class="w-full mt-1 border rounded px-2 py-1.5 dark:bg-gray-700 dark:border-gray-600 focus-trap"><button id="saveKeyBtn" class="absolute right-1 top-1/2 -translate-y-1/2 bg-blue-600 text-white px-2 py-0.5 rounded focus-trap">Save</button></div><div id="apiStatus" class="hidden text-green-500 text-sm mt-1">API Key saved <button id="resetKeyBtn" class="ml-2 text-red-500 underline focus-trap">Change</button></div></div>
      <div><label for="tempInput">Default Temperature: <span id="tempLabel">1.0</span></label><input id="tempInput" type="range" min="0" max="2" step="0.05" class="w-full mt-1 focus-trap"></div>
      <label class="inline-flex items-center gap-2"><input id="themeToggle" type="checkbox" class="accent-blue-600 focus-trap"><span>Dark Mode</span></label>
      <label class="inline-flex items-center gap-2"><input id="ttsToggle" type="checkbox" class="accent-blue-600 focus-trap"><span>Auto-play TTS on response</span></label>
    </div>
    <!-- Model Visibility -->
    <div class="space-y-2">
      <h3 class="text-lg font-medium border-b pb-2">Visible Models</h3>
      <div id="modelVisibilityList" class="space-y-1 max-h-60 overflow-y-auto text-sm pr-2">Loading models...</div>
    </div>
  </div>
</template>

<!-- ───────────────── Script ───────────────── -->
<script type="module">
document.addEventListener('DOMContentLoaded', () => {
/* ─── Globals, State & Helpers ────────────────── */
const $ = id => document.getElementById(id);
const md = txt => DOMPurify.sanitize(marked.parse(txt, { gfm: true, breaks: true, smartLists: true }));
let state = {
    apiKey: '', theme: 'light', model: 'gpt-4o', temperature: 1.0, autoRead: false,
    threads: [], currentThread: null, modelVisibility: {}
};
let tokenizer = null;
let currentAudio = null;

async function initializeApp() {
    try {
        await window.tiktoken.init((imports) => WebAssembly.instantiate(new URL("https://cdn.jsdelivr.net/npm/@dqbd/tiktoken@1.0.14/lite/tiktoken_bg.wasm", import.meta.url), imports));
        tokenizer = new window.tiktoken.Tiktoken(
            (await (await fetch("https://cdn.jsdelivr.net/npm/@dqbd/tiktoken@1.0.14/encoders/cl100k_base.json")).json()).bpe_ranks,
            { "<|endoftext|>": 100257, "<|fim_prefix|>": 100258, "<|fim_middle|>": 100259, "<|fim_suffix|>": 100260, "<|endofprompt|>": 100276 },
            "'(?i:[sdmt]|ll|ve|re)|'t|'s|'m|'d| ?\\p{L}+| ?\\p{N}+| ?[^\\s\\p{L}\\p{N}]+|\\s+(?!\\S)|\\s+"
        );
        console.log("tiktoken initialized.");
    } catch (e) {
        console.error("Failed to load tiktoken tokenizer. Using approximation.", e);
    }
    loadState();
}

async function calculateTokens(text) {
    if (tokenizer) return tokenizer.encode(text).length;
    return Math.ceil((text || '').length / 4); // Fallback
}

/* ─── State Management ────────────────── */
function loadState() {
    const savedState = localStorage.getItem('appState');
    if (savedState) state = { ...state, ...JSON.parse(savedState) };
    
    // UI setup from state
    document.documentElement.classList.toggle('dark', state.theme === 'dark');
    $('currentModel').textContent = state.model;
    updateAttachButtonVisibility();
    
    if (!state.currentThread && state.threads.length > 0) state.currentThread = state.threads[0].id;
    renderThreads();
    loadThread();
}
function saveState() { localStorage.setItem('appState', JSON.stringify(state)); }

/* ─── UI: Main Elements & Theme ────────────────── */
const ta = $('userInput'), sendBtn = $('sendBtn'), sendIcon = $('sendIcon'), spinner = $('spinner');
ta.addEventListener('input', () => {
    ta.style.height = 'auto';
    ta.style.height = Math.min(ta.scrollHeight, 256) + 'px';
    sendBtn.disabled = ta.value.trim().length === 0;
});
$('menuBtn').onclick = () => $('sidebar').classList.add('open');
$('closeSidebar').onclick = () => $('sidebar').classList.remove('open');
$('newChatBtnHeader').onclick = newThread;

function updateAttachButtonVisibility() {
    const visionModels = ["gpt-4o", "gpt-4o-mini", "gpt-4-turbo", "gpt-4-vision"];
    const isVisionModel = visionModels.some(vm => state.model.startsWith(vm));
    $('attachBtn').classList.toggle('hidden', !isVisionModel);
}

/* ─── Threads Management ────────────────── */
function renderThreads() {
  const ul = $('threadList'); ul.innerHTML = '';
  state.threads.forEach(t => {
    const li = document.createElement('li');
    li.className = 'p-2 rounded flex items-center justify-between ' + (t.id === state.currentThread ? 'bg-blue-100 dark:bg-gray-700' : 'hover:bg-gray-200 dark:hover:bg-gray-700');
    li.innerHTML = `<span class="flex-1 truncate">${t.title}</span><span class="text-xs opacity-70 mr-1">$${(t.cost || 0).toFixed(4)}</span>`;
    li.onclick = () => { if (state.currentThread === t.id) return; state.currentThread = t.id; saveState(); renderThreads(); loadThread(); $('sidebar').classList.remove('open'); };
    ul.appendChild(li);
  });
}
function loadThread() {
    $('chat').innerHTML = '';
    const th = state.threads.find(x => x.id === state.currentThread);
    if (!th) { updateCostUI(0, 0); return; }
    th.messages.forEach((m, index) => addMsg(m, index));
    updateCostUI(0, th.cost || 0);
}
function newThread() {
  const id = Date.now().toString();
  state.threads.unshift({ id, title: 'New Chat', messages: [], cost: 0 });
  state.currentThread = id;
  saveState(); renderThreads(); loadThread();
}

/* ─── Message Rendering & Actions ────────────────── */
function addMsg(message, index) {
    const chat = $('chat');
    const div = document.createElement('div');
    div.className = 'group';
    let innerHTML = '';

    if (message.role === 'user') {
        innerHTML = `<div class="text-right text-xs text-gray-400">You</div><div class="inline-block bg-blue-500 text-white rounded-lg p-3">${md(message.content)}</div>`;
        div.className += ' text-right';
    } else { // Assistant
        innerHTML = `<div class="text-left text-xs text-gray-400">ChatGPT</div>
                     <div class="relative inline-block bg-gray-200 dark:bg-gray-700 rounded-lg p-3">
                       <div class="prose dark:prose-invert max-w-none">${md(message.content)}</div>
                       <div class="msg-actions absolute -bottom-2.5 right-2 flex items-center gap-2 bg-gray-100 dark:bg-gray-600 px-2 py-0.5 rounded-full border border-gray-200 dark:border-gray-500 opacity-0 group-hover:opacity-100 transition-opacity">
                         <button class="speak-btn" title="Play/Stop Audio"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m-2.121-2.121a2 2 0 010 2.828M12 18h.01M17 12a5 5 0 00-5-5m0 0a5 5 0 00-5 5m5-5v7a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2z"></path></svg></button>
                         <button class="regen-btn" title="Regenerate Response"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4a14.95 14.95 0 0114.65 12.35M20 20a14.95 14.95 0 01-14.65-12.35"/></svg></button>
                       </div>
                     </div>`;
    }
    div.innerHTML = innerHTML;
    chat.appendChild(div);

    if (message.role === 'assistant') {
        const textContent = message.content;
        div.querySelector('.speak-btn').onclick = () => toggleTTS(textContent, div.querySelector('.speak-btn'));
        div.querySelector('.regen-btn').onclick = () => regenerateResponse(index);
    }
    chat.scrollTop = chat.scrollHeight;
}

function updateCostUI(last, total) {
  $('liveCost').textContent = `≈$${total.toFixed(5)}`;
}

function toggleTTS(text, btn) {
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        if (currentAudio === text) { currentAudio = null; return; }
    }
    currentAudio = text;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.onend = () => { currentAudio = null; };
    speechSynthesis.speak(utterance);
}

async function regenerateResponse(assistantMsgIndex) {
    const th = state.threads.find(x => x.id === state.currentThread);
    if (!th || assistantMsgIndex === 0) return;

    const userMsgIndex = assistantMsgIndex - 1;
    const userMessage = th.messages[userMsgIndex];
    if (userMessage.role !== 'user') return;

    // Subtract cost of the old response
    const oldAssistantMsg = th.messages[assistantMsgIndex];
    const oldCost = oldAssistantMsg.cost || 0;
    th.cost -= oldCost;
    
    // Remove old message and send new one
    th.messages.splice(assistantMsgIndex, 1);
    
    // Re-render UI to remove the old message visually before sending new one
    loadThread();

    await sendMsg(userMessage.content);
}

/* ─── API Interaction ────────────────── */
async function sendMsg(contentOverride = null) {
  if (!state.apiKey) { alert('Set your API key first'); return; }
  const content = contentOverride ?? ta.value.trim();
  if (!content) return;

  if (!contentOverride) ta.value = '';
  ta.dispatchEvent(new Event('input'));
  spinner.classList.remove('hidden'); sendIcon.classList.add('hidden'); sendBtn.disabled = true;

  const th = state.threads.find(x => x.id === state.currentThread);
  const userMessage = { role: 'user', content };
  
  if (!contentOverride) {
      th.messages.push(userMessage);
      addMsg(userMessage, th.messages.length - 1);
  }
  
  if (th.title === 'New Chat') th.title = content.slice(0, 30);
  
  const inT = await calculateTokens(JSON.stringify(th.messages));
  let acc = '', outT = 0;

  try {
    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + state.apiKey },
      body: JSON.stringify({ model: state.model, messages: th.messages, temperature: +state.temperature, stream: true })
    });
    if (!res.ok) throw new Error(`API Error: ${res.status} ${(await res.text())}`);
    
    const assistContainer = document.createElement('div');
    assistContainer.className = 'group';
    assistContainer.innerHTML = `<div class="text-left text-xs text-gray-400">ChatGPT</div><div class="relative inline-block bg-gray-200 dark:bg-gray-700 rounded-lg p-3"><div class="prose dark:prose-invert max-w-none assist-content"></div><div class="msg-actions absolute -bottom-2.5 right-2 flex items-center gap-2 bg-gray-100 dark:bg-gray-600 px-2 py-0.5 rounded-full border border-gray-200 dark:border-gray-500 opacity-0 group-hover:opacity-100 transition-opacity"><button class="speak-btn"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m-2.121-2.121a2 2 0 010 2.828M12 18h.01M17 12a5 5 0 00-5-5m0 0a5 5 0 00-5 5m5-5v7a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2z"></path></svg></button><button class="regen-btn"><svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4a14.95 14.95 0 0114.65 12.35M20 20a14.95 14.95 0 01-14.65-12.35"/></svg></button></div></div>`;
    $('chat').appendChild(assistContainer);
    
    const rd = res.body.getReader(), dec = new TextDecoder();
    while (true) {
      const { value, done } = await rd.read();
      if (done) break;
      const chunk = dec.decode(value);
      const lines = chunk.split('\n\n');
      for (const line of lines) {
        if (line.startsWith('data: ')) {
            const data = line.substring(6);
            if (data.trim() === '[DONE]') break;
            const delta = JSON.parse(data).choices[0].delta.content || '';
            acc += delta;
            assistContainer.querySelector('.assist-content').innerHTML = md(acc);
            $('chat').scrollTop = $('chat').scrollHeight;
        }
      }
    }
    
    outT = await calculateTokens(acc);
    const rate = state.model.startsWith('gpt-4') ? [0.03, 0.06] : [0.0005, 0.0015]; // Simplified
    const cost = (inT / 1000 * rate[0]) + (outT / 1000 * rate[1]);
    th.cost = (th.cost || 0) + cost;

    const newAssistantMsg = { role: 'assistant', content: acc, cost };
    th.messages.push(newAssistantMsg);

    const newIndex = th.messages.length - 1;
    assistContainer.querySelector('.speak-btn').onclick = () => toggleTTS(acc, assistContainer.querySelector('.speak-btn'));
    assistContainer.querySelector('.regen-btn').onclick = () => regenerateResponse(newIndex);
    
    if (state.autoRead && !contentOverride) toggleTTS(acc);

  } catch (err) {
    console.error(err);
    addMsg({role: 'assistant', content: `⚠️ Error: ${err.message}`}, -1);
  } finally {
    saveState(); renderThreads(); updateCostUI(0, th.cost);
    spinner.classList.add('hidden'); sendIcon.classList.remove('hidden');
    ta.dispatchEvent(new Event('input'));
  }
}

/* ─── Modals (Model & Settings) ────────────────── */
// --- Model Modal ---
$('modelBtn').onclick = () => { $('modelModal').classList.replace('hidden', 'flex'); populateModels(); };
$('closeModelModal').onclick = () => $('modelModal').classList.replace('flex', 'hidden');

async function populateModels() {
  const box = $('modelList'); box.innerHTML = 'Loading…';
  let models = ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-3.5-turbo'];
  if (state.apiKey) { try { const r = await fetch('https://api.openai.com/v1/models', { headers: { Authorization: 'Bearer ' + state.apiKey }}); models = (await r.json()).data.map(m => m.id).filter(id => /^gpt-/.test(id) && !id.includes('instruct')).sort(); } catch (e) { console.error(e); }}
  
  const visibleModels = models.filter(m => state.modelVisibility[m] !== false);
  box.innerHTML = '';
  visibleModels.forEach(id => {
    const btn = document.createElement('button');
    btn.className = 'block w-full text-left px-2 py-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700 focus-trap';
    btn.textContent = id + (id === state.model ? ' ✅' : '');
    btn.onclick = () => { state.model = id; $('currentModel').textContent = id; saveState(); populateModels(); updateAttachButtonVisibility(); };
    box.appendChild(btn);
  });
}

// --- Settings Modal ---
$('settingsOpener').onclick = () => { $('settingsModal').classList.replace('hidden', 'flex'); renderSettings(); };
$('closeSettingsModal').onclick = () => $('settingsModal').classList.replace('flex', 'hidden');

function renderSettings() {
    const content = $('settingsContent');
    content.innerHTML = $('settings-template').innerHTML;

    // Load state into settings UI
    $('apiKeyInput').value = state.apiKey;
    keyUI(!!state.apiKey);
    $('tempInput').value = state.temperature;
    $('tempLabel').textContent = state.temperature;
    $('themeToggle').checked = state.theme === 'dark';
    $('ttsToggle').checked = state.autoRead;

    // Add event listeners
    $('saveKeyBtn').onclick = () => { const k = $('apiKeyInput').value.trim(); if (k) { state.apiKey = k; saveState(); keyUI(true); populateModelVisibilityList(); }};
    $('resetKeyBtn').onclick = () => { state.apiKey = ''; saveState(); keyUI(false); $('apiKeyInput').value = ''; };
    $('tempInput').oninput = e => { $('tempLabel').textContent = e.target.value; };
    $('tempInput').onchange = e => { state.temperature = +e.target.value; saveState(); };
    $('themeToggle').onchange = e => { state.theme = e.target.checked ? 'dark' : 'light'; document.documentElement.classList.toggle('dark', e.target.checked); saveState(); };
    $('ttsToggle').onchange = e => { state.autoRead = e.target.checked; saveState(); };

    populateModelVisibilityList();
}

async function populateModelVisibilityList() {
    const listDiv = $('modelVisibilityList');
    if (!listDiv) return;
    listDiv.innerHTML = 'Loading...';
    if (!state.apiKey) { listDiv.innerHTML = 'Please enter an API key to see model list.'; return; }

    try {
        const r = await fetch('https://api.openai.com/v1/models', { headers: { Authorization: 'Bearer ' + state.apiKey }});
        if (!r.ok) throw new Error('Failed to fetch models');
        const models = (await r.json()).data.map(m => m.id).filter(id => /^gpt-/.test(id) && !id.includes('instruct')).sort();
        
        listDiv.innerHTML = '';
        models.forEach(modelId => {
            const label = document.createElement('label');
            label.className = 'flex items-center gap-2 p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-600';
            const isVisible = state.modelVisibility[modelId] !== false; // Default to visible
            label.innerHTML = `<input type="checkbox" class="model-visibility-toggle accent-blue-600" data-model-id="${modelId}" ${isVisible ? 'checked' : ''}><span>${modelId}</span>`;
            listDiv.appendChild(label);
        });

        listDiv.querySelectorAll('.model-visibility-toggle').forEach(toggle => {
            toggle.onchange = (e) => {
                state.modelVisibility[e.target.dataset.modelId] = e.target.checked;
                saveState();
            };
        });
    } catch (e) {
        listDiv.innerHTML = 'Could not fetch models. Check your API key.';
        console.error(e);
    }
}

function keyUI(has) {
    if (!$('apiStatus')) return;
    $('apiStatus').classList.toggle('hidden', !has);
    $('apiKeyContainer').style.display = has ? 'none' : 'block';
}

/* ─── Initial Load ───────────────────────── */
initializeApp();
});
</script>
</body>
</html>
