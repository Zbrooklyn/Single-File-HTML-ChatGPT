<!-- FILE: chat_client_final_v5_stable.html -->
<!DOCTYPE html>
<html lang="en" class="scroll-smooth h-full">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ChatGPT Polished Client</title>
  <meta name="description" content="A feature-complete, privacy-first, single-file client for OpenAI models.">
  <link rel="manifest" href="data:application/manifest+json,{"name":"ChatGPT Polished","short_name":"Chat","start_url":".","display":"standalone","background_color":"#111827","theme_color":"#2563eb","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50,9A41,41,0,0,0,9,50a41,41,0,0,0,41,41,40.7,40.7,0,0,0,29.12-12.07l-10-10A25.82,25.82,0,0,1,50,75.82,25.82,25.82,0,1,1,75.82,50H63.18a13.18,13.18,0,1,0-13.18,13.18V50A13.18,13.18,0,1,0,50,36.82,13.18,13.18,0,0,0,36.82,50H50A25.82,25.82,0,0,1,50,9Z' fill='%232563eb'/%3E%3C/svg%3E","sizes":"192x192","type":"image/svg+xml"}]}">

  <!-- Content-Security-Policy -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://*.tailwindcss.com https://*.jsdelivr.net https://api.openai.com;
                 img-src 'self' data: blob: https://oaidalleapiprodscus.blob.core.windows.net;
                 style-src 'self' 'unsafe-inline' https://*.tailwindcss.com;
                 script-src 'self' 'unsafe-inline' https://*.jsdelivr.net https://cdn.tailwindcss.com https://cdnjs.cloudflare.com blob:;
                 worker-src 'self' blob:;
                 media-src 'self' blob:;
                 manifest-src data:;">

  <!-- Libs: Tailwind, marked, DOMPurify, tiktoken, jsPDF, html2canvas -->
  <script src="https://cdn.tailwindcss.com?plugins=typography,forms"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script type="module">import * as tiktoken from "https://cdn.jsdelivr.net/npm/@dqbd/tiktoken@1.0.14/lite/init.js"; window.tiktoken = tiktoken;</script>

  <style>
    :root { --toast-translate-y: 120%; }
    html { scroll-behavior: smooth; }
    .sidebar { transform: translateX(-100%); transition: transform .3s ease; }
    .sidebar.open { transform: translateX(0); }
    textarea { overflow-y: auto; resize: none; }
    .modal-bg { background: rgba(0,0,0,.6); backdrop-filter: blur(4px); }
    .focus-trap:focus-visible { outline: 2px solid #2563eb; outline-offset: 2px; }
    #toast { transform: translateY(var(--toast-translate-y)); transition: transform .3s ease; }
    .prose table { width: 100%; border-collapse: collapse; }
    .prose th, .prose td { border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; }
    .prose th { background-color: #f3f4f6; font-weight: 600; }
    .dark .prose th { background-color: #374151; }
    .dark .prose th, .dark .prose td { border-color: #4b5563; }
    .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 12px; height: 12px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="flex flex-col h-full bg-white dark:bg-gray-900 text-gray-800 dark:text-white overflow-x-hidden">

<!-- DYNAMIC UI ELEMENTS -->
<div id="toast-container" class="fixed bottom-4 right-4 z-[100]"><div id="toast" class="bg-gray-800 dark:bg-gray-200 text-white dark:text-black py-2 px-4 rounded-lg shadow-xl"></div></div>
<!-- Unlock Modal Has Been Removed -->

<!-- HEADER -->
<nav class="fixed inset-x-0 top-0 flex items-center gap-2 px-2 sm:px-4 py-2 bg-blue-600 dark:bg-gray-800 text-white z-20"><button id="menuBtn" class="p-1 focus-trap"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button><button id="modelBtn" class="flex items-center px-2 py-1 bg-white text-gray-800 dark:bg-gray-700 rounded focus-trap"><span id="currentModel" class="truncate max-w-[6rem] sm:max-w-[8rem]"></span><svg class="h-4 w-4 ml-1" fill="currentColor" viewBox="0 0 20 20"><path d="M5.23 7.21a.75.75 0 011.06.02L10 11.087l3.71-3.856a.75.75 0 011.08 1.04l-4.25 4.414a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z"/></svg></button><span id="liveCost" class="text-xs opacity-80"></span><span class="flex-1"></span><button id="newChatBtnHeader" class="p-2 bg-white text-gray-800 dark:bg-gray-700 rounded-full focus-trap"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></button><button id="settingsOpener" class="p-2 bg-white text-gray-800 dark:bg-gray-700 rounded-full focus-trap"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-1.57 1.992A1.532 1.532 0 013.17 8.51c-1.56.38-1.56 2.6 0 2.98a1.532 1.532 0 01.948 2.286c-.836 1.372.734 2.942 1.992 1.57a1.532 1.532 0 012.286.948c.38 1.56 2.6 1.56 2.98 0a1.532 1.532 0 012.286-.948c1.372.836 2.942-.734 1.57-1.992a1.532 1.532 0 01-.948-2.286c1.56-.38 1.56-2.6 0-2.98a1.532 1.532 0 01-.948-2.286c.836-1.372-.734-2.942-1.992-1.57a1.532 1.532 0 01-2.286-.948zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/></svg></button></nav>

<!-- SIDEBAR -->
<aside id="sidebar" class="sidebar fixed top-0 left-0 h-full w-full sm:w-72 bg-white dark:bg-gray-800 shadow-lg p-4 pt-20 z-10 overflow-y-auto"><button id="closeSidebar" class="absolute top-4 right-4 text-gray-700 dark:text-white focus-trap">✖</button><ul id="threadList" class="space-y-1"></ul><div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700"><button id="promptLibraryOpener" class="w-full text-left p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 focus-trap loc" data-loc="prompt_library">Prompt Library</button><button id="exportAllBtn" class="w-full text-left p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 focus-trap loc" data-loc="export_all">Export All Chats</button></div></aside>

<!-- CHAT AREA -->
<main class="flex-1 flex flex-col pt-16 pb-20"><section id="chat" role="log" class="flex-1 overflow-y-auto p-2 sm:p-4 space-y-4"></section></main>

<!-- INPUT BAR -->
<div class="fixed bottom-0 inset-x-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-2 sm:p-4"><div class="max-w-4xl mx-auto"><div id="imagePreviews" class="flex gap-2 mb-2"></div><label class="flex items-center gap-2 text-xs mb-1 text-gray-500" id="webSearchContainer"><input type="checkbox" id="webSearchToggle" class="form-checkbox h-4 w-4 text-blue-600 rounded"><span class="loc" data-loc="web_search_label">Search the web</span></label><div class="flex gap-2 items-end"><button id="attachBtn" class="p-2.5 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 focus-trap hidden" title="Attach Image"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg></button><textarea id="userInput" rows="1" placeholder="Type a message…" class="flex-1 border rounded-lg px-3 py-2.5 dark:bg-gray-700 dark:border-gray-600 focus-trap"></textarea><button id="sendBtn" class="bg-blue-600 text-white px-4 py-2.5 rounded-lg flex items-center focus-trap" disabled><svg id="sendIcon" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg><svg id="spinner" class="h-5 w-5 animate-spin hidden" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V8z"/></svg></button></div></div></div>

<!-- MODALS -->
<div id="modelModal" class="modal-bg fixed inset-0 hidden items-center justify-center z-30" role="dialog"><div class="bg-white dark:bg-gray-800 rounded-lg w-11/12 max-w-sm p-4 relative shadow-lg max-h-[80vh] overflow-y-auto"><button id="closeModelModal" class="absolute top-3 right-3 text-gray-500 focus-trap">✖</button><h2 class="text-lg font-semibold text-center mb-3 loc" data-loc="switch_model">Switch model</h2><div id="modelList" class="space-y-2"></div></div></div>
<div id="settingsModal" class="modal-bg fixed inset-0 hidden items-center justify-center z-40" role="dialog"><div class="bg-white dark:bg-gray-800 rounded-lg w-11/12 max-w-3xl p-4 sm:p-6 relative shadow-lg max-h-[90vh] overflow-y-auto"><button id="closeSettingsModal" class="absolute top-3 right-3 text-gray-500 focus-trap">✖</button><h2 class="text-2xl font-semibold mb-4 loc" data-loc="settings">Settings</h2><div class="space-y-6" id="settingsContent"></div></div></div>
<div id="promptLibraryModal" class="modal-bg fixed inset-0 hidden items-center justify-center z-50" role="dialog"><div class="bg-white dark:bg-gray-800 rounded-lg w-11/12 max-w-xl p-6 relative shadow-lg max-h-[80vh] flex flex-col"><button id="closePromptLibraryModal" class="absolute top-3 right-3 text-gray-500 focus-trap">✖</button><h2 class="text-xl font-semibold mb-4 loc" data-loc="prompt_library">Prompt Library</h2><div id="promptList" class="flex-1 overflow-y-auto space-y-2 pr-2"></div><div class="mt-4 flex gap-2"><input id="newPromptName" placeholder="Prompt Name" class="flex-1 border rounded px-2 py-1.5 dark:bg-gray-700 dark:border-gray-600 focus-trap"><button id="savePromptBtn" class="bg-blue-600 text-white px-3 rounded focus-trap loc" data-loc="save_current_prompt">Save Current</button></div></div></div>
<div id="tosModal" class="modal-bg fixed inset-0 hidden items-center justify-center z-50"><div class="bg-white dark:bg-gray-800 rounded-lg w-11/12 max-w-2xl p-6 relative shadow-lg max-h-[80vh] overflow-y-auto"><button id="closeTosModal" class="absolute top-3 right-3 text-gray-500 focus-trap">✖</button><div id="tosContent" class="prose prose-sm dark:prose-invert max-w-none"></div></div></div>
<input type="file" id="attachFileInput" class="hidden" accept="image/*">
<input type="file" id="importFileInput" class="hidden" accept=".json">

<!-- TEMPLATES -->
<template id="settings-template">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
    <div class="space-y-4"><h3 class="text-lg font-medium border-b pb-2 loc" data-loc="config">Configuration</h3><div><label class="text-sm font-medium loc" data-loc="api_key">API Key</label><div id="apiKeyContainer" class="relative"><input id="apiKeyInput" type="password" placeholder="sk-..." class="form-input w-full mt-1 dark:bg-gray-700 dark:border-gray-600"><button id="saveKeyBtn" class="absolute right-1 top-1/2 -translate-y-1/2 bg-blue-600 text-white px-2 py-0.5 rounded focus-trap loc" data-loc="save">Save</button></div><div id="apiStatus" class="hidden text-green-500 text-sm mt-1"></div></div><div><label class="text-sm font-medium">Default Temperature: <span id="tempLabel"></span></label><input id="tempInput" type="range" min="0" max="2" step="0.05" class="w-full mt-1"></div><div class="flex items-center justify-between"><label class="text-sm font-medium loc" data-loc="language">Language</label><select id="languageSelect" class="form-select dark:bg-gray-700 dark:border-gray-600 rounded-md text-sm py-1"></select></div><label class="flex items-center gap-3"><input id="themeToggle" type="checkbox" class="form-checkbox rounded"><span>Use Dark Mode</span></label></div>
    <div class="space-y-4"><h3 class="text-lg font-medium border-b pb-2 loc" data-loc="audio">Audio</h3><label class="flex items-center gap-3"><input id="ttsToggle" type="checkbox" class="form-checkbox rounded"><span>Auto-play TTS on response</span></label><div><label for="ttsProvider" class="text-sm font-medium loc" data-loc="tts_provider">TTS Provider</label><select id="ttsProvider" class="form-select w-full mt-1 dark:bg-gray-700 dark:border-gray-600"></select></div><div id="openaiVoiceContainer" class="hidden"><label for="openaiVoice" class="text-sm font-medium loc" data-loc="openai_voice">OpenAI Voice</label><select id="openaiVoice" class="form-select w-full mt-1 dark:bg-gray-700 dark:border-gray-600"></select></div></div>
    <div class="md:col-span-2 space-y-2"><h3 class="text-lg font-medium border-b pb-2 loc" data-loc="security_data">Data</h3><div class="flex gap-2 flex-wrap"><!-- Set Encryption Button Has Been Removed --><button id="exportPdfBtn" class="bg-gray-200 dark:bg-gray-700 text-sm px-3 py-1.5 rounded focus-trap loc" data-loc="export_pdf">Export Thread to PDF</button><button id="importBtn" class="bg-gray-200 dark:bg-gray-700 text-sm px-3 py-1.5 rounded focus-trap loc" data-loc="import_json">Import from JSON</button></div></div>
    <div class="md:col-span-2 space-y-2">
      <h3 class="text-lg font-medium border-b pb-2 loc" data-loc="model_management">Model Management</h3>
      <p class="text-xs text-gray-500 loc" data-loc="model_management_desc">Select which models appear in the model switcher. Requires a valid API key.</p>
      <div id="modelVisibilityList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-1 max-h-48 overflow-y-auto pr-2">
      </div>
    </div>
  </div>
  <div class="mt-6 pt-4 border-t"><p class="text-xs text-gray-500">ChatGPT Polished Client v5.0 | <button id="tosOpener" class="underline loc" data-loc="tos_privacy">Terms of Service & Privacy</button></p></div>
</template>

<script type="module">
// Initialize Libraries
const { jsPDF } = window.jspdf;
const { html2canvas } = window;

/* ─── Globals, State & Helpers ────────────────── */
const $ = id => document.getElementById(id);
const md = txt => DOMPurify.sanitize(marked.parse(txt, { gfm: true, breaks: true, smartLists: true }));
const VISION_MODELS = ["gpt-4o", "gpt-4o-mini", "gpt-4-turbo", "gpt-4-vision-preview"];
const TARIFF = { 'gpt-4o': [0.005, 0.015], 'gpt-4o-mini': [0.00015, 0.0006], 'gpt-4-turbo': [0.01, 0.03], 'gpt-4-vision-preview': [0.01, 0.03], 'gpt-4': [0.03, 0.06], 'gpt-4-32k': [0.06, 0.12], 'gpt-3.5-turbo': [0.0005, 0.0015] };
const DEFAULT_RATE = [0.01, 0.03];
const L = {
    en: { switch_model: "Switch model", settings: "Settings", prompt_library: "Prompt Library", export_all: "Export All Chats", web_search_label: "Search the web", save_current_prompt: "Save Current Prompt", config: "Configuration", api_key: "API Key", save: "Save", audio: "Audio", tts_provider: "TTS Provider", openai_voice: "OpenAI Voice", security_data: "Data", export_pdf: "Export Thread to PDF", import_json: "Import from JSON", tos_privacy: "Terms of Service & Privacy", language: "Language", api_key_saved: "API Key saved.", change: "Change", api_key_removed: "API Key removed.", model_management: "Model Management", model_management_desc: "Select which models appear in the model switcher. Requires a valid API key." },
    es: { switch_model: "Cambiar Modelo", settings: "Ajustes", prompt_library: "Biblioteca de Prompts", export_all: "Exportar Todos los Chats", web_search_label: "Buscar en la web", save_current_prompt: "Guardar Prompt Actual", config: "Configuración", api_key: "Clave de API", save: "Guardar", audio: "Audio", tts_provider: "Proveedor de TTS", openai_voice: "Voz de OpenAI", security_data: "Datos", export_pdf: "Exportar Hilo a PDF", import_json: "Importar desde JSON", tos_privacy: "Términos de Servicio y Privacidad", language: "Idioma", api_key_saved: "Clave de API guardada.", change: "Cambiar", api_key_removed: "Clave de API eliminada.", model_management: "Gestión de Modelos", model_management_desc: "Seleccione qué modelos aparecen en el selector de modelos. Requiere una clave de API válida." }
};

let state = {
    apiKey: '', theme: 'light', model: 'gpt-4o', temperature: 1.0, autoRead: false,
    threads: [], currentThread: null, modelVisibility: {}, prompts: [],
    ttsProvider: 'browser', openaiVoice: 'alloy', language: 'en'
};
let tokenizer, currentAudioPlayer, attachedImages = [];

// Decoupled initialization for stability
initializeApp();

async function initializeApp() {
    registerServiceWorker();
    await loadState();
    try {
        await window.tiktoken.init((imports) => WebAssembly.instantiate(new URL("https://cdn.jsdelivr.net/npm/@dqbd/tiktoken@1.0.14/lite/tiktoken_bg.wasm", import.meta.url), imports));
        tokenizer = new window.tiktoken.Tiktoken((await(await fetch("https://cdn.jsdelivr.net/npm/@dqbd/tiktoken@1.0.14/encoders/cl100k_base.json")).json()).bpe_ranks,{ "<|endoftext|>": 100257 },"'(?i:[sdmt]|ll|ve|re)|'t|'s|'m|'d| ?\\p{L}+| ?\\p{N}+| ?[^\\s\\p{L}\\p{N}]+|\\s+(?!\\S)|\\s+");
    } catch (e) { console.error("Tokenizer failed to load. Using approximation.", e); }
}

const loc = (key) => L[state.language]?.[key] || L['en'][key];
function localizeUI() { document.querySelectorAll('[data-loc]').forEach(el => { el.textContent = loc(el.dataset.loc); }); }
async function calculateTokens(text) { if (tokenizer) return tokenizer.encode(text).length; return Math.ceil((text || '').length / 4); }
const costOf = (m, inT, outT) => { const rate = TARIFF[Object.keys(TARIFF).find(k => m.startsWith(k))] || DEFAULT_RATE; return (inT / 1000 * rate[0]) + (outT / 1000 * rate[1]); };
let toastTimer;
function showToast(message) { clearTimeout(toastimer); const toast = $('toast'); toast.textContent = message; document.documentElement.style.setProperty('--toast-translate-y', '0'); toastTimer = setTimeout(() => document.documentElement.style.setProperty('--toast-translate-y', '120%'), 3000); }

/* ─── State, PWA ────────────────── */
async function loadState() {
    const s = localStorage.getItem('appState');
    if (s) {
        try {
            state = { ...state, ...JSON.parse(s) };
            setupUI();
        } catch (e) {
            console.error("Could not parse saved state. It might be encrypted or corrupted. Starting fresh.", e);
            firstRunSetup();
        }
    } else {
        firstRunSetup();
    }
}
function firstRunSetup() { $('tosModal').classList.replace('hidden', 'flex'); $('tosContent').innerHTML = `<h2>Welcome!</h2><p>This is a client-side application. Your API key and chats are stored in your browser's LocalStorage. By using this app, you agree to take responsibility for securing your own data and API key. No data is sent to any server except OpenAI's official API.</p><p>Please set your API key in the settings to begin.</p>`; setupUI(); }
async function saveState() {
    localStorage.setItem('appState', JSON.stringify(state));
}
function setupUI() { document.documentElement.lang = state.language; document.documentElement.classList.toggle('dark', state.theme === 'dark'); $('currentModel').textContent = state.model; updateAttachButtonVisibility(); if (!state.currentThread && state.threads.length > 0) state.currentThread = state.threads[0].id; renderThreads(); loadThread(); localizeUI(); }
function updateAttachButtonVisibility() { const isVision = VISION_MODELS.some(m => state.model.startsWith(m)); $('attachBtn').classList.toggle('hidden', !isVision); }
function registerServiceWorker() { if ('serviceWorker' in navigator) { const swJS = `const CACHE_NAME='chat-final-v1';self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE_NAME).then(c=>c.add('/'))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`; navigator.serviceWorker.register(`data:text/javascript,${encodeURIComponent(swJS)}`).catch(e => console.error('SW registration failed:', e)); } }

/* ─── UI & Event Listeners ────────────────── */
const ta = $('userInput'), sendBtn = $('sendBtn');
const updateSendButton = () => { sendBtn.disabled = ta.value.trim().length === 0 && attachedImages.length === 0; };
ta.addEventListener('input', () => { ta.style.height = 'auto'; ta.style.height = Math.min(ta.scrollHeight, 256) + 'px'; updateSendButton(); });
const modalAction = (modalId, action) => $(modalId).classList.replace(action === 'open' ? 'hidden' : 'flex', action === 'open' ? 'flex' : 'hidden');
$('menuBtn').onclick = () => $('sidebar').classList.add('open');
$('closeSidebar').onclick = () => $('sidebar').classList.remove('open');
$('newChatBtnHeader').onclick = newThread;
$('attachBtn').onclick = () => $('attachFileInput').click();
$('attachFileInput').onchange = handleFileAttachment;
sendBtn.onclick = () => sendMsg();
document.addEventListener('keydown', e => { if (e.key === 'Escape') { ['modelModal', 'settingsModal', 'promptLibraryModal', 'tosModal'].forEach(id => modalAction(id, 'close')); } });

/* ─── Thread Management & Rendering ────────────────── */
function renderThreads() { const ul = $('threadList'); ul.innerHTML = ''; state.threads.forEach(t => { const li = document.createElement('li'); li.className = `p-2 rounded flex items-center justify-between cursor-pointer ${t.id === state.currentThread ? 'bg-blue-100 dark:bg-gray-700' : 'hover:bg-gray-200 dark:hover:bg-gray-700'}`; li.innerHTML = `<span class="flex-1 truncate">${t.title}</span><span class="text-xs opacity-70 mr-1">$${(t.cost || 0).toFixed(4)}</span>`; li.onclick = () => { if (state.currentThread === t.id) return; state.currentThread = t.id; saveState(); renderThreads(); loadThread(); $('sidebar').classList.remove('open'); }; ul.appendChild(li); }); }
function loadThread() { $('chat').innerHTML = ''; const th = state.threads.find(x => x.id === state.currentThread); if (!th) { updateCostUI(0, 0); return; } th.messages.forEach((m, index) => addMsg(m, index)); updateCostUI(0, th.cost || 0); }
function newThread() { const id = Date.now().toString(); state.threads.unshift({ id, title: 'New Chat', messages: [], cost: 0 }); state.currentThread = id; ta.value = ''; attachedImages = []; renderImagePreviews(); updateSendButton(); saveState(); renderThreads(); loadThread(); }
function addMsg(message, index) { const chat = $('chat'), div = document.createElement('div'); let innerHTML = '';
    if(message.role === 'system'){ innerHTML = `<div class="text-center text-xs text-gray-400 p-2 my-2 border-t border-b dark:border-gray-700 flex items-center justify-center gap-2">${md(message.content)}</div>`; }
    else if (message.role === 'user') { let textContent = '', imageHTML = ''; if (Array.isArray(message.content)) { message.content.forEach(p => { if (p.type === 'text') textContent = p.text; if (p.type === 'image_url') imageHTML += `<img src="${p.image_url.url}" class="max-w-xs rounded-lg mt-2" alt="User attachment">`; }); } else { textContent = message.content; } innerHTML = `<div class="text-right text-xs text-gray-400 mb-1">You</div><div class="ml-auto bg-blue-500 text-white rounded-lg p-3 max-w-xl inline-block">${md(textContent)}${imageHTML}</div>`; div.className = 'text-right'; }
    else { innerHTML = `<div class="text-left text-xs text-gray-400 mb-1">ChatGPT</div><div class="relative group bg-gray-200 dark:bg-gray-700 rounded-lg p-3 max-w-xl inline-block" id="msg-${index}"><div class="prose dark:prose-invert max-w-none">${md(message.content)}</div><div class="msg-actions absolute -bottom-2.5 right-2 flex items-center gap-2 bg-gray-100 dark:bg-gray-600 px-2 py-0.5 rounded-full border border-gray-200 dark:border-gray-500 opacity-0 group-hover:opacity-100 transition-opacity"><button class="speak-btn p-1" title="Play/Stop Audio"><svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg></button><button class="regen-btn p-1" title="Regenerate Response"><svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"></path></svg></button></div></div>`; }
    div.innerHTML = innerHTML; chat.appendChild(div); if (message.role === 'assistant') { div.querySelector('.speak-btn').onclick = (e) => toggleTTS(message.content, e.currentTarget); div.querySelector('.regen-btn').onclick = () => regenerateResponse(index); }
}
function updateCostUI(last, total) { $('liveCost').textContent = `≈$${total.toFixed(5)}`; }
async function regenerateResponse(assistantMsgIndex) { const th = state.threads.find(x => x.id === state.currentThread); if (!th || assistantMsgIndex === 0) return; th.cost -= (th.messages[assistantMsgIndex].cost || 0); th.messages.splice(assistantMsgIndex); loadThread(); await sendMsg(th.messages[th.messages.length - 1].content, true); }
function handleFileAttachment(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (re) => { attachedImages.push({ data: re.target.result }); renderImagePreviews(); updateSendButton(); }; reader.readAsDataURL(file); } e.target.value = null; }
function renderImagePreviews() { const container = $('imagePreviews'); container.innerHTML = ''; attachedImages.forEach((img, index) => { const div = document.createElement('div'); div.className = 'relative'; div.innerHTML = `<img src="${img.data}" class="h-16 w-16 object-cover rounded-md"><button class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs">×</button>`; div.querySelector('button').onclick = () => { attachedImages.splice(index, 1); renderImagePreviews(); updateSendButton(); }; container.appendChild(div); }); }

/* ─── API & Audio ────────────────── */
async function fetchWithRetry(url, options, retries = 3, delay = 1000) { try { const res = await fetch(url, options); if (!res.ok && (res.status === 429 || res.status >= 500) && retries > 0) { await new Promise(r => setTimeout(r, delay)); return fetchWithRetry(url, options, retries - 1, delay * 2); } return res; } catch (err) { if (retries > 0) { await new Promise(r => setTimeout(r, delay)); return fetchWithRetry(url, options, retries - 1, delay * 2); } throw err; } }
async function sendMsg(contentOverride = null, isRegen = false) {
    if (!state.apiKey) { showToast('Set your API key first'); return; }
    const textContent = contentOverride ?? ta.value.trim();
    if (!textContent && attachedImages.length === 0) return;

    $('spinner').classList.remove('hidden'); $('sendIcon').classList.add('hidden'); sendBtn.disabled = true;
    const th = state.threads.find(x => x.id === state.currentThread);
    
    // Add a system message for web search indication, if enabled
    if ($('webSearchToggle').checked && !isRegen) {
        addMsg({role: 'system', content: '<div class="loader"></div> Searching the web...'}, th.messages.length);
    }
    
    let userMessageContent = [];
    if (textContent) userMessageContent.push({ type: 'text', text: textContent });
    attachedImages.forEach(img => userMessageContent.push({ type: "image_url", image_url: { url: img.data } }));
    if (userMessageContent.length === 1 && userMessageContent[0].type === 'text') {
        userMessageContent = userMessageContent[0].text;
    }

    if (!isRegen) {
        th.messages.push({ role: 'user', content: userMessageContent });
        addMsg(th.messages[th.messages.length - 1], th.messages.length - 1);
    }
    if (th.title === 'New Chat') {
        th.title = typeof userMessageContent === 'string' ? userMessageContent.slice(0, 30) : (userMessageContent.find(p => p.type === 'text')?.text.slice(0, 30) || 'Image Query');
    }
    ta.value = ''; attachedImages = []; renderImagePreviews(); updateSendButton(); ta.dispatchEvent(new Event('input'));
  
    const requestBody = { model: state.model, messages: th.messages, temperature: state.temperature, stream: true };
    if ($('webSearchToggle').checked) {
        requestBody.tools = [{ type: 'web_search' }];
        $('webSearchToggle').checked = false; // Reset after use
    }
    
    const inT = await calculateTokens(JSON.stringify(requestBody));
    let acc = '', outT = 0, toolCallAcc = '';
    
    // Create a single div for the assistant response that will be updated
    const assistantMsgIndex = th.messages.length;
    addMsg({role: 'assistant', content: '...'}, assistantMsgIndex);
    const currentMessageDiv = $(`msg-${assistantMsgIndex}`);
    const contentDiv = currentMessageDiv.querySelector('.prose');

    try {
        const res = await fetchWithRetry('https://api.openai.com/v1/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + state.apiKey }, body: JSON.stringify(requestBody) });
        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`API Error: ${res.status} ${errorText}`);
        }
    
        const rd = res.body.getReader(), dec = new TextDecoder();
        while (true) {
            const { value, done } = await rd.read();
            if (done) break;
            const chunk = dec.decode(value);
            const lines = chunk.split('\n\n');
            for(const line of lines){
                if (line.startsWith('data: ')) {
                    const data = line.substring(6);
                    if (data.trim() === '[DONE]') break;
                    try {
                        const parsed = JSON.parse(data);
                        const delta = parsed.choices[0].delta;
                        if (delta.content) {
                            acc += delta.content;
                            contentDiv.innerHTML = md(acc);
                        }
                        if (delta.tool_calls) {
                            const toolCall = delta.tool_calls[0];
                            if (toolCall.function.name) {
                                const systemMsg = document.querySelector('#chat .text-center');
                                if (systemMsg) systemMsg.innerHTML = `<div class="loader"></div> Executing search...`;
                            }
                        }
                    } catch (e) {
                        console.warn("Could not parse stream chunk:", data);
                    }
                }
            }
        }
    
        outT = await calculateTokens(acc);
        const cost = costOf(state.model, inT, outT);
        th.cost = (th.cost || 0) + cost;

        const newAssistantMsg = { role: 'assistant', content: acc, cost };
        th.messages[assistantMsgIndex] = newAssistantMsg;
        
        currentMessageDiv.parentElement.remove();
        addMsg(newAssistantMsg, assistantMsgIndex);

        if (state.autoRead && !isRegen) {
            toggleTTS(newAssistantMsg.content, document.querySelector(`#msg-${assistantMsgIndex} .speak-btn`));
        }

    } catch (err) {
        console.error(err);
        if (currentMessageDiv) currentMessageDiv.parentElement.remove();
        addMsg({role: 'assistant', content: `⚠️ Error: ${err.message}`}, -1);
    } finally {
        saveState();
        renderThreads();
        updateCostUI(0, th.cost);
        $('spinner').classList.add('hidden');
        $('sendIcon').classList.remove('hidden');
        updateSendButton();
    }
}
async function toggleTTS(text, btn) {
    if (currentAudioPlayer && !currentAudioPlayer.paused) { currentAudioPlayer.pause(); return; }
    btn.innerHTML = `<div class="loader"></div>`;
    const playIcon = '<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>';
    const stopIcon = '<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18V6h2v12H6zm8-12v12h2V6h-2z"/></svg>';

    const resetUI = () => { currentAudioPlayer = null; btn.innerHTML = playIcon; };

    if (state.ttsProvider === 'browser') {
        if (speechSynthesis.speaking) speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.onstart = () => btn.innerHTML = stopIcon;
        u.onend = resetUI;
        speechSynthesis.speak(u);
    } else {
        try {
            const res = await fetchWithRetry('https://api.openai.com/v1/audio/speech', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + state.apiKey }, body: JSON.stringify({ model: 'tts-1', input: text, voice: state.openaiVoice }) });
            if (!res.ok) throw new Error('TTS API request failed');
            const blob = await res.blob();
            currentAudioPlayer = new Audio(URL.createObjectURL(blob));
            currentAudioPlayer.play();
            btn.innerHTML = stopIcon;
            currentAudioPlayer.onended = resetUI;
            currentAudioPlayer.onpause = resetUI;
        } catch (e) { showToast('Failed to play OpenAI TTS.'); console.error(e); resetUI(); }
    }
}

/* ─── Modals, Settings & Data I/O ────────────────── */
function setupModal(modalId, openBtnId, beforeOpen) { const openBtn = $(openBtnId); if(openBtn) openBtn.onclick = () => { if (beforeOpen) beforeOpen(); modalAction(modalId, 'open'); }; $(`close${modalId.charAt(0).toUpperCase() + modalId.slice(1)}`).onclick = () => modalAction(modalId, 'close'); }
setupModal('modelModal', 'modelBtn', populateModels);
setupModal('settingsModal', 'settingsOpener', renderSettings);
setupModal('promptLibraryModal', 'promptLibraryOpener', renderPrompts);
setupModal('tosModal', 'tosOpener', () => { $('tosContent').innerHTML = `<h2>Terms & Privacy</h2><p>This is a client-side application. Your API key and chats are stored in your browser's LocalStorage. By using this app, you agree to take responsibility for securing your own data and API key. No data is sent to any server except OpenAI's official API.</p>`});
async function populateModels() { const box = $('modelList'); box.innerHTML = `<div class="flex justify-center items-center gap-2 text-gray-400"><div class="loader"></div><span>Fetching models...</span></div>`; let models = ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-3.5-turbo']; if (state.apiKey) { try { const r = await fetch('https://api.openai.com/v1/models', { headers: { Authorization: 'Bearer ' + state.apiKey }}); models = (await r.json()).data.map(m => m.id).filter(id => /^gpt-/.test(id) && !id.includes('instruct')).sort(); } catch (e) { box.textContent = 'Could not fetch models.'; return; }} const visibleModels = models.filter(m => state.modelVisibility[m] !== false); box.innerHTML = ''; visibleModels.forEach(id => { const btn = document.createElement('button'); btn.className = `block w-full text-left px-2 py-1 rounded focus-trap ${id === state.model ? 'bg-blue-100 dark:bg-gray-600' : 'hover:bg-gray-200 dark:hover:bg-gray-700'}`; btn.textContent = id + (id === state.model ? ' ✅' : ''); btn.onclick = () => { state.model = id; $('currentModel').textContent = id; saveState(); populateModels(); updateAttachButtonVisibility(); modalAction('modelModal', 'close'); }; box.appendChild(btn); }); }
function renderSettings() {
    $('settingsContent').innerHTML = $('settings-template').innerHTML;
    // Load state
    $('apiKeyInput').value = state.apiKey; keyUI(!!state.apiKey);
    $('tempInput').value = state.temperature; $('tempLabel').textContent = state.temperature;
    $('themeToggle').checked = state.theme === 'dark';
    $('ttsToggle').checked = state.autoRead;
    const ttsProviderSelect = $('ttsProvider'); ['browser', 'openai'].forEach(p => ttsProviderSelect.add(new Option(p.charAt(0).toUpperCase() + p.slice(1), p, p === state.ttsProvider, p === state.ttsProvider)));
    const openaiVoiceSelect = $('openaiVoice'); ['alloy', 'echo', 'fable', 'onyx', 'nova', 'shimmer'].forEach(v => openaiVoiceSelect.add(new Option(v.charAt(0).toUpperCase() + v.slice(1), v, v === state.openaiVoice, v === state.openaiVoice)));
    $('openaiVoiceContainer').classList.toggle('hidden', state.ttsProvider !== 'openai');
    const langSelect = $('languageSelect'); Object.keys(L).forEach(lang => langSelect.add(new Option(lang.toUpperCase(), lang, lang === state.language, lang === state.language)));
    // Event listeners
    $('saveKeyBtn').onclick = () => { const k = $('apiKeyInput').value.trim(); if (k) { state.apiKey = k; saveState(); keyUI(true); populateModelVisibilityList(); showToast(loc('api_key_saved')); }};
    $('tempInput').oninput = e => { $('tempLabel').textContent = e.target.value; };
    $('tempInput').onchange = e => { state.temperature = +e.target.value; saveState(); };
    $('themeToggle').onchange = e => { state.theme = e.target.checked ? 'dark' : 'light'; document.documentElement.classList.toggle('dark', e.target.checked); saveState(); };
    $('ttsToggle').onchange = e => { state.autoRead = e.target.checked; saveState(); };
    ttsProviderSelect.onchange = e => { state.ttsProvider = e.target.value; $('openaiVoiceContainer').classList.toggle('hidden', e.target.value !== 'openai'); saveState(); };
    openaiVoiceSelect.onchange = e => { state.openaiVoice = e.target.value; saveState(); };
    langSelect.onchange = e => { state.language = e.target.value; saveState(); localizeUI(); renderSettings(); };
    setupDataButtons();
    populateModelVisibilityList();
    localizeUI();
}
function keyUI(has) { if (!$('apiStatus')) return; const status = $('apiStatus'); status.innerHTML = has ? loc('api_key_saved') + ` <button id="resetKeyBtn" class="ml-2 text-red-500 underline focus-trap">${loc('change')}</button>` : ''; status.classList.toggle('hidden', !has); $('apiKeyContainer').style.display = has ? 'none' : 'block'; if (has) $('resetKeyBtn').onclick = () => { state.apiKey = ''; saveState(); keyUI(false); $('apiKeyInput').value = ''; showToast(loc('api_key_removed')); }; }
async function populateModelVisibilityList() { const listDiv = $('modelVisibilityList'); if (!listDiv) return; listDiv.innerHTML = `<div class="flex items-center gap-2 text-gray-400"><div class="loader"></div><span>Fetching models...</span></div>`; if (!state.apiKey) { listDiv.innerHTML = 'Enter API key.'; return; } try { const r = await fetch('https://api.openai.com/v1/models', { headers: { Authorization: 'Bearer ' + state.apiKey }}); if (!r.ok) throw new Error('Failed to fetch'); const models = (await r.json()).data.map(m => m.id).filter(id => /^gpt-/.test(id) && !id.includes('instruct')).sort(); listDiv.innerHTML = ''; models.forEach(id => { const label = document.createElement('label'); label.className = 'flex items-center gap-3 p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-600'; const isVisible = state.modelVisibility[id] !== false; label.innerHTML = `<input type="checkbox" class="model-visibility-toggle form-checkbox rounded" data-model-id="${id}" ${isVisible ? 'checked' : ''}><span>${id}</span>`; listDiv.appendChild(label); }); listDiv.querySelectorAll('.model-visibility-toggle').forEach(toggle => { toggle.onchange = e => { state.modelVisibility[e.target.dataset.modelId] = e.target.checked; saveState(); }; }); } catch (e) { listDiv.innerHTML = '<span class="text-red-500">Could not fetch models.</span>'; console.error(e); } }
function setupDataButtons() {
    $('exportPdfBtn').onclick = async () => { const th = state.threads.find(x => x.id === state.currentThread); if (!th) return showToast('No thread selected.'); showToast('Generating PDF...'); const chatEl = $('chat'); const canvas = await html2canvas(chatEl, { scale: 2, logging: false, useCORS: true, backgroundColor: state.theme === 'dark' ? '#111827' : '#ffffff' }); const imgData = canvas.toDataURL('image/png'); const pdf = new jsPDF('p', 'mm', 'a4'); const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = pdf.internal.pageSize.getHeight(); const canvasWidth = canvas.width; const canvasHeight = canvas.height; const ratio = canvasWidth / pdfWidth; const imgHeight = canvasHeight / ratio; let heightLeft = imgHeight; let position = 0; pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight); heightLeft -= pdfHeight; while (heightLeft > 0) { position = -heightLeft; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight); heightLeft -= pdfHeight; } pdf.save(`${th.title.replace(/ /g, '_')}.pdf`); };
    $('importBtn').onclick = () => $('importFileInput').click();
    $('importFileInput').onchange = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (re) => { try { const imported = JSON.parse(re.target.result); if(imported.threads) state = {...state, ...imported}; else if (Array.isArray(imported)) state.threads = imported; else throw new Error("Invalid format"); state.currentThread = state.threads[0]?.id || null; saveState(); renderThreads(); loadThread(); showToast('Import successful!'); } catch(err){ showToast('Import failed: ' + err.message); } }; reader.readAsText(file); } };
    $('exportAllBtn').onclick = () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state)); const a = document.createElement('a'); a.href = dataStr; a.download = `chat_export_${Date.now()}.json`; a.click(); showToast('All application data exported.'); };
}
function renderPrompts() { const listDiv = $('promptList'); listDiv.innerHTML = ''; (state.prompts || []).forEach((p, i) => { const div = document.createElement('div'); div.className = 'p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 flex justify-between items-center'; div.innerHTML = `<span>${p.name}</span><div class="flex gap-1"><button class="use-prompt bg-blue-500 text-white text-xs px-2 py-1 rounded">Use</button><button class="del-prompt bg-red-500 text-white text-xs px-2 py-1 rounded">Del</button></div>`; div.querySelector('.use-prompt').onclick = () => { ta.value = p.text; modalAction('promptLibraryModal', 'close'); updateSendButton(); }; div.querySelector('.del-prompt').onclick = () => { state.prompts.splice(i, 1); saveState(); renderPrompts(); }; listDiv.appendChild(div); }); }
$('savePromptBtn').onclick = () => { const name = $('newPromptName').value.trim(), text = ta.value.trim(); if (name && text) { if(!state.prompts) state.prompts = []; state.prompts.push({ name, text }); $('newPromptName').value = ''; saveState(); renderPrompts(); } };

</script>
</body>
</html>
